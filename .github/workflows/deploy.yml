# 워크플로우 이름
name: Frontend CI/CD

# 워크플로우 실행 조건: main 브랜치에 push 이벤트 발생 시
on:
  push:
    branches: [ "main" ]

# 실행될 작업(job) 목록
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. 소스 코드 체크아웃
      - name: Checkout Code
        uses: actions/checkout@v4

      # 2. Node.js 18 버전 설치
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      # 3. 의존성 패키지 설치
      - name: Install Dependencies
        run: npm install

      # 4. 빌드 시 사용할 .env 파일 생성
      - name: Create .env file for build
        run: |
          echo "VITE_APP_API_URL=${{ secrets.VITE_APP_API_URL }}" >> .env
          echo "VITE_APP_WS_URL=${{ secrets.VITE_APP_WS_URL }}" >> .env
          echo "VITE_ONE_SIGNAL_APP_ID=${{ secrets.VITE_ONE_SIGNAL_APP_ID }}" >> .env

      # 5. React 애플리케이션 빌드
      - name: Build Project
        run: npm run build

      # 6. AWS 자격 증명 설정
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # 7. 빌드 결과물을 S3 버킷에 업로드
      - name: Upload to S3
        run: aws s3 sync ./dist s3://${{ secrets.AWS_S3_BUCKET }} --delete

      # 8. CloudFront 캐시 무효화 (사용자가 즉시 변경사항을 보도록 함)
      - name: Invalidate CloudFront
        run: aws cloudfront create-invalidation --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} --paths "/*"
      
      # 9. Discord 알림 (배포 성공/실패 시)
      - name: Discord Notification
        if: always()
        uses: appleboy/discord-action@master
        with:
          webhook_url: ${{ secrets.DISCORD_WEBHOOK_URL_FE }} # 프론트엔드용 웹훅 URL
          message: |
            **Frontend CI/CD Status: ${{ job.status }}**
            Repository: ${{ github.repository }}
            Commit: ${{ github.sha }}
            <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Workflow Run>
